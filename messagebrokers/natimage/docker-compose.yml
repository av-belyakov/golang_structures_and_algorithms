#https://habr.com/ru/articles/793050/
#https://docs.nats.io/running-a-nats-service/configuration/monitoring

services:
  nats:
    image: nats:latest
    container_name: nats-server
    hostname: nats-server
    restart: unless-stopped
    ports:
     - 4222:4222
     - 8222:8222
     #- 6222:6222 //для кластера
    command: "--config nats-server.conf"
    volumes:
      - $PWD/nats-server.conf:/etc/nats/nats-server.conf:ro
      - $PWD/jetstream-cluster/n1:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
     - internal-network

  nats-exporter:
    image: natsio/prometheus-nats-exporter:latest
    container_name: nats-exporter
    restart: unless-stopped
    ports:
      - 7777:7777
    command: >
      -D 
      --addr 0.0.0.0 
      --port 7777 
      -varz
      -connz
      -routez
      -subz
      -jsz=all 
      http://nats-server:8222
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - internal-network
    depends_on:
      - nats

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    restart: unless-stopped
    ports:
      - 9090:9090
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    volumes:
      - $PWD/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - internal-network
    depends_on:
      - nats
      - nats-exporter

  grafana:
    image: grafana/grafana
    container_name: grafana
    restart: unless-stopped
    ports:
      - 3000:3000
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin  
    volumes:
      - grafana-data:/var/lib/grafana
      - $PWD/grafana/provisioning:/etc/grafana/provisioning
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro  
    networks:
      - internal-network
    depends_on:
      - prometheus

networks:
  internal-network:
    driver: bridge

volumes:
  prometheus-data:
    driver: local
  grafana-data:
    driver: local